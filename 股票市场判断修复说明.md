# 股票市场判断修复说明

## 🐛 问题描述

原来的代码在判断股票市场时存在错误：
- 原代码：`code.startsWith('000') ? '0' : '1'`
- 问题：只判断了000开头的股票为深圳市场，但实际上0开头、3开头、8开头的都是深圳市场

## ✅ 修复方案

### 1. 修复市场判断逻辑

**修复前：**
```javascript
const secid = code.startsWith('000') ? `0.${code}` : `1.${code}`;
```

**修复后：**
```javascript
const marketType = this.getMarketType(code);
const secid = `${marketType}.${code}`;
```

### 2. 新增getMarketType方法

```javascript
static getMarketType(code) {
  // 股票代码市场判断规则：
  // 0开头：深圳主板 (000001, 000002等)
  // 3开头：创业板 (300001, 300002等) 
  // 6开头：上海主板 (600000, 600036等)
  // 688开头：科创板 (688001, 688002等)
  // 8开头：新三板 (800001, 800002等)
  
  if (code.startsWith('0') || code.startsWith('3') || code.startsWith('8')) {
    return '0'; // 深圳市场
  } else if (code.startsWith('6')) {
    return '1'; // 上海市场
  } else {
    // 默认按上海市场处理
    return '1';
  }
}
```

### 3. 新增getMarketName方法

```javascript
static getMarketName(code) {
  if (code.startsWith('000')) {
    return '深圳主板';
  } else if (code.startsWith('002')) {
    return '深圳中小板';
  } else if (code.startsWith('300')) {
    return '创业板';
  } else if (code.startsWith('600') || code.startsWith('601') || code.startsWith('603') || code.startsWith('605')) {
    return '上海主板';
  } else if (code.startsWith('688')) {
    return '科创板';
  } else if (code.startsWith('8')) {
    return '新三板';
  } else {
    return '未知市场';
  }
}
```

## 📊 股票代码规则

### 深圳市场 (secid = 0.股票代码)
- **000xxx**: 深圳主板 (如：000001 平安银行)
- **002xxx**: 深圳中小板 (如：002415 海康威视)
- **300xxx**: 创业板 (如：300001 特锐德)
- **8xxxxx**: 新三板 (如：800001)

### 上海市场 (secid = 1.股票代码)
- **600xxx**: 上海主板 (如：600000 浦发银行)
- **601xxx**: 上海主板 (如：601318 中国平安)
- **603xxx**: 上海主板 (如：603259 药明康德)
- **605xxx**: 上海主板 (如：605117 德业股份)
- **688xxx**: 科创板 (如：688001 华兴源创)

## 🧪 测试验证

### 测试用例
| 股票代码 | 期望市场 | 期望secid | 实际结果 |
|---------|---------|----------|---------|
| 000001  | 深圳主板 | 0.000001 | ✅ 正确 |
| 000002  | 深圳主板 | 0.000002 | ✅ 正确 |
| 002415  | 深圳中小板 | 0.002415 | ✅ 正确 |
| 300001  | 创业板 | 0.300001 | ✅ 正确 |
| 600000  | 上海主板 | 1.600000 | ✅ 正确 |
| 600036  | 上海主板 | 1.600036 | ✅ 正确 |
| 600519  | 上海主板 | 1.600519 | ✅ 正确 |
| 688001  | 科创板 | 1.688001 | ✅ 正确 |
| 800001  | 新三板 | 0.800001 | ✅ 正确 |

### 测试方法
1. 打开 `client/test/marketTest.html` 在浏览器中测试
2. 运行 `client/test/marketTest.js` 进行程序化测试
3. 在自选股监控页面添加不同市场的股票进行验证

## 🎯 影响范围

### 修复的文件
1. **client/services/stockService.js**
   - 修复 `getKlineUrl` 方法中的市场判断
   - 修复 `getStockInfo` 方法中的市场判断
   - 新增 `getMarketType` 方法
   - 新增 `getMarketName` 方法

2. **client/components/PortfolioMonitor.jsx**
   - 添加市场信息显示
   - 在表格中显示股票所属市场

### 功能改进
1. **API调用正确性**: 确保所有API调用都使用正确的secid格式
2. **用户体验**: 在自选股列表中显示股票所属市场
3. **错误处理**: 更好的股票代码验证和错误提示

## 🚀 使用建议

1. **测试验证**: 建议先测试几只不同市场的股票
2. **数据验证**: 确认API返回的数据正确
3. **功能测试**: 测试自选股监控页面的各项功能

## 📝 注意事项

1. **股票代码格式**: 确保输入的股票代码是6位数字
2. **市场识别**: 系统会自动识别股票所属市场
3. **API兼容性**: 修复后的代码与东方财富API完全兼容
4. **错误处理**: 对于无法识别的股票代码，默认按上海市场处理

现在股票市场判断已经修复，可以正确处理所有沪深市场的股票代码了！
